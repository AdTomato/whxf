<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.authine.cloudpivot.web.api.mapper.ScaleTestResultMapper">

    <resultMap id="resultAndDanger" type="java.util.Map">
        <id property="result" column="result" javaType="java.lang.String" jdbcType="VARCHAR"></id>
        <id property="danger" column="danger" jdbcType="VARCHAR"></id>
    </resultMap>

    <select id="getResultByScore" resultMap="resultAndDanger">
        select result,danger from igpgf_scale_test_result  where parentId=#{parentId}
        and min_score <![CDATA[ <= ]]> #{score} and
        #{score} <![CDATA[ <= ]]> max_score
        LIMIT 1
    </select>

    <select id="getIdByddId" resultType="java.lang.String">
        SELECT id
        FROM h_org_user
        WHERE userId = #{userId}
    </select>

    <select id="getoptionResult" resultType="java.lang.String">
        SELECT optionResult
        FROM igpgf_scale_test_detail
        WHERE id = #{id}
    </select>

    <insert id="insertScaleTestAcore" parameterType="com.authine.cloudpivot.web.api.entity.ScaleTestAcore">
        INSERT INTO igpgf_scale_test_acore
       (id, name, creater, createdDeptId, owner, ownerDeptId, createdTime,
            modifier,modifiedTime, workflowInstanceId,
            sequenceNo, sequenceStatus,ownerDeptQueryCode,
            scaleTest,userId,testTime,testScore,
            testResult,testDetail,danger)
        VALUES (#{id}, #{name}, #{creater}, #{createdDeptId}, #{owner}, #{ownerDeptId},
                now(), #{modifier}, now(), #{workflowInstanceId},
                #{sequenceNo},#{sequenceStatus}, #{ownerDeptQueryCode},
                #{scaleTest},#{userId},  now(), #{testScore},
                #{testResult}, #{testDetail}, #{danger})
    </insert>

    <select id="getScaleTestResultInfo" resultType="com.authine.cloudpivot.web.api.entity.ScaleTestAcore"
            parameterType="com.authine.cloudpivot.web.api.entity.ScaleTestAcore">
        select a.*,
        b.name as userName,b.gender as userSex,TIMESTAMPDIFF(YEAR, b.birthday, CURDATE()) as userAge,
        b.departmentId as userdeptId,b.imgUrl as userImgUrl, c.name as userdeptName,d.title   as scaleTestName,
        d.smallTypeName as smallTypeNameId,e.smallTypeName as smallTypeName
         from igpgf_scale_test_acore a
         left join h_org_user b on a.userId like concat('%',b.id,'%')
          left join h_org_department c on  b.departmentId=c.id
        left join igpgf_scale_test d on a.scaleTest=d.id
        left join igpgf_scale_type_small e on d.smallTypeName=e.id
        where 1=1
        <if test="scaleTest != null and scaleTest != ''">
          and  a.scaleTest=#{scaleTest}
        </if>
        <if test="userId != null and userId != ''">
            and a.userId like concat('%',#{userId},'%')
        </if>
        <if test="testTime != null "><!--时间不能用 ！='' -->
            AND date_format(a.testTime, '%Y-%m-%d') = date_format(#{testTime}, '%Y-%m-%d')
        </if>
        <if test="danger != null and danger != ''">
            AND a.danger=#{danger}
        </if>
        <if test="resolved != null and resolved != ''">
            AND a.resolved=#{resolved}
        </if>
    </select>

</mapper>